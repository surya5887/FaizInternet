{% extends "base.html" %}

{% block title %}Book {{ service.title }} - Faiz Internet{% endblock %}

{% block extra_css %}
<style>
    .booking-wrapper {
        padding: 80px 0;
        background: var(--background);
        background-image: var(--gradient-bg);
        min-height: calc(100vh - 200px);
    }
    .service-header {
        display: flex;
        align-items: center;
        gap: 25px;
        margin-bottom: 40px;
        padding-bottom: 30px;
        border-bottom: 1px solid rgba(155, 93, 229, 0.15);
    }
    .service-header .service-icon-box {
        width: 100px;
        height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(155, 93, 229, 0.08);
        border-radius: 20px;
        border: 1px solid rgba(155, 93, 229, 0.2);
        flex-shrink: 0;
    }
    .service-header .service-icon-box i {
        font-size: 2.5rem;
        color: var(--accent-purple);
    }
    .service-title {
        font-size: 2.2rem;
        color: var(--white);
        margin-bottom: 8px;
    }
    .grid-form {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }
    .full-width {
        grid-column: 1 / -1;
    }
    .info-box {
        background: rgba(155, 93, 229, 0.05);
        border-left: 4px solid var(--accent-purple);
        padding: 20px;
        border-radius: var(--border-radius-sm);
        margin-bottom: 30px;
        font-size: 0.95rem;
        color: var(--white);
    }
    .doc-upload-section {
        margin-top: 30px;
        padding-top: 30px;
        border-top: 1px solid rgba(155, 93, 229, 0.15);
    }
    .doc-upload-field {
        background: rgba(155, 93, 229, 0.04);
        padding: 20px;
        border-radius: var(--border-radius-md);
        border: 1px solid rgba(155, 93, 229, 0.1);
        margin-bottom: 15px;
    }
    .doc-upload-field label {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
        font-weight: 600;
        color: var(--white);
    }
    .doc-upload-field label i {
        color: var(--accent-purple);
    }
    @media (max-width: 768px) {
        .grid-form { grid-template-columns: 1fr; }
        .service-header { flex-direction: column; text-align: center; }
    }
</style>
{% endblock %}

{% block content %}
<div class="booking-wrapper">
    <div class="container" style="max-width: 900px;">
        <div class="premium-card premium-form">
            
            <div class="service-header">
                <div class="service-icon-box">
                    <i class="fa-solid fa-file-lines"></i>
                </div>
                <div>
                    <h2 class="service-title">Apply for {{ service.title }}</h2>
                    <p style="color: var(--text-light); font-size: 1.1rem; margin: 0;">{{ service.description }}</p>
                </div>
            </div>

            <div class="info-box">
                <i class="fa-solid fa-circle-user" style="margin-right: 10px; font-size: 1.2rem; color: var(--accent-purple);"></i>
                Applying as <strong style="color: var(--accent-gold);">{{ current_user.name }}</strong> ({{ current_user.phone }}). We will contact you at <strong style="color: var(--accent-gold);">{{ current_user.email }}</strong> regarding this application.
            </div>

            <form method="POST" action="{{ url_for('book_service', service_id=service.id) }}" enctype="multipart/form-data">
                
                <div class="form-group full-width">
                    <label>Application Type</label>
                    <select name="application_type" class="form-control">
                        <option value="New Application">New Application</option>
                        <option value="Correction / Update">Correction / Update</option>
                        <option value="Replacement / Reprint">Replacement / Reprint</option>
                    </select>
                </div>

                <div class="grid-form">
                    {% if schema %}
                        {% for field in schema %}
                            <div class="form-group {% if field.get('type') == 'textarea' %}full-width{% endif %}">
                                <label for="{{ field.get('name', 'field_' ~ loop.index0) }}">{{ field.get('label', 'Field') }} {% if field.get('required') %}<span style="color:var(--accent-orange);">*</span>{% endif %}</label>
                                
                                {% if field.get('type') == 'textarea' %}
                                    <textarea id="{{ field.get('name') }}" name="{{ field.get('name') }}" class="form-control" rows="3" {% if field.get('required') %}required{% endif %}></textarea>
                                {% elif field.get('type') == 'date' %}
                                    <input type="date" id="{{ field.get('name') }}" name="{{ field.get('name') }}" class="form-control" {% if field.get('required') %}required{% endif %}>
                                {% elif field.get('type') == 'select' %}
                                    <select id="{{ field.get('name') }}" name="{{ field.get('name') }}" class="form-control" {% if field.get('required') %}required{% endif %}>
                                        <option value="">-- Select --</option>
                                        {% for opt in field.get('options', []) %}
                                        <option value="{{ opt }}">{{ opt }}</option>
                                        {% endfor %}
                                    </select>
                                {% else %}
                                    <input type="{{ field.get('type', 'text') }}" id="{{ field.get('name') }}" name="{{ field.get('name') }}" class="form-control" {% if field.get('required') %}required{% endif %}>
                                {% endif %}
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>

                <!-- Premium Stylish Document Upload Section -->
                {% if doc_fields %}
                <div class="doc-upload-section">
                    <h3 style="color: var(--white); font-size: 1.4rem; margin-bottom: 25px; display: flex; align-items: center; gap: 12px;">
                        <i class="fa-solid fa-cloud-arrow-up" style="color: var(--accent-purple); filter: drop-shadow(0 0 8px rgba(155, 93, 229, 0.4));"></i> 
                        Required Documents
                    </h3>
                    
                    {% for doc_field in doc_fields %}
                    <div class="doc-upload-field premium-card" style="padding: 25px; background: rgba(155, 93, 229, 0.03);">
                        <label style="font-size: 1.1rem; margin-bottom: 15px;">
                            <i class="fa-solid fa-file-shield" style="color: var(--accent-purple);"></i>
                            {{ doc_field.get('label', 'Document') }} 
                            {% if doc_field.get('required') %}
                                <span class="badge" style="background: rgba(255, 107, 53, 0.15); color: var(--accent-orange); font-size: 0.7rem; margin-left: 8px;">REQUIRED</span>
                            {% endif %}
                        </label>

                        {% if doc_field.get('sub_inputs') and doc_field.get('sub_inputs')|length > 0 %}
                            <!-- Multi-part Upload (e.g. Front & Back) -->
                            <div class="multi-upload-grid">
                                {% set outer_loop_index = loop.index0 %}
                                {% for sub_label in doc_field.get('sub_inputs') %}
                                <div class="sub-input-group">
                                    <span class="sub-input-label">{{ sub_label }}</span>
                                    <div class="stylish-upload-container" onclick="this.querySelector('input').click()">
                                        <div class="upload-icon-box">
                                            <i class="fa-solid fa-camera"></i>
                                        </div>
                                        <span class="upload-text-main">Choose File</span>
                                        <span class="upload-text-sub">or drag & drop</span>
                                        <input type="file" name="doc_{{ outer_loop_index }}_{{ loop.index0 }}" 
                                               class="file-input-hidden" accept=".pdf,.jpg,.jpeg,.png"
                                               {% if doc_field.get('required') %}data-required="true"{% endif %}
                                               onchange="handlePreview(this)">
                                        <div class="file-preview-area">
                                            <i class="fa-solid fa-circle-check"></i>
                                            <span class="file-name-text">No file selected</span>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <!-- Single Stylish Upload -->
                            <div class="stylish-upload-container" onclick="this.querySelector('input').click()">
                                <div class="upload-icon-box">
                                    <i class="fa-solid fa-upload"></i>
                                </div>
                                <span class="upload-text-main">Click to Upload Document</span>
                                <span class="upload-text-sub">PDF, JPG, or PNG (Max 2MB per file advised)</span>
                                <input type="file" name="doc_field_{{ loop.index0 }}" 
                                       class="file-input-hidden" accept=".pdf,.jpg,.jpeg,.png"
                                       {% if doc_field.get('required') %}data-required="true"{% endif %}
                                       onchange="handlePreview(this)">
                                <div class="file-preview-area">
                                    <i class="fa-solid fa-circle-check"></i>
                                    <span class="file-name-text">No file selected</span>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <script>
                function handlePreview(input) {
                    const container = input.closest('.stylish-upload-container');
                    const previewArea = container.querySelector('.file-preview-area');
                    const fileNameText = container.querySelector('.file-name-text');
                    
                    if (input.files && input.files[0]) {
                        previewArea.classList.add('active');
                        fileNameText.textContent = input.files[0].name;
                        container.style.borderColor = 'var(--accent-blue)';
                        container.style.background = 'rgba(0, 245, 212, 0.05)';
                        container.querySelector('.upload-text-main').style.color = 'var(--white)';
                        
                        const errorMsg = container.querySelector('.validation-error-msg');
                        if (errorMsg) errorMsg.remove();
                    } else {
                        previewArea.classList.remove('active');
                        container.style.borderColor = '';
                        container.style.background = '';
                    }
                }

                // Add drag & drop support
                document.querySelectorAll('.stylish-upload-container').forEach(container => {
                    container.addEventListener('dragover', e => {
                        e.preventDefault();
                        container.classList.add('drag-over');
                    });
                    container.addEventListener('dragleave', () => {
                        container.classList.remove('drag-over');
                    });
                    container.addEventListener('drop', e => {
                        e.preventDefault();
                        container.classList.remove('drag-over');
                        const input = container.querySelector('input');
                        if (e.dataTransfer.files.length) {
                            input.files = e.dataTransfer.files;
                            handlePreview(input);
                        }
                    });
                });

                // Custom validation to highlight empty required file inputs visibly and check total payload size
                document.querySelector('form').addEventListener('submit', function(e) {
                    let isValid = true;
                    
                    let totalSize = 0;
                    const allFiles = this.querySelectorAll('input[type="file"]');
                    allFiles.forEach(input => {
                        if (input.files.length > 0) {
                            totalSize += input.files[0].size;
                        }
                    });

                    const submitBtn = this.querySelector('button[type="submit"]');
                    const existingSizeError = document.getElementById('size-error-msg');
                    if (existingSizeError) existingSizeError.remove();

                    if (totalSize > 4 * 1024 * 1024) { // 4MB Limit for Vercel Hobby
                        isValid = false;
                        
                        const sizeError = document.createElement('div');
                        sizeError.id = 'size-error-msg';
                        sizeError.style.color = 'var(--accent-orange)';
                        sizeError.style.background = 'rgba(255, 107, 53, 0.1)';
                        sizeError.style.border = '1px dashed var(--accent-orange)';
                        sizeError.style.padding = '15px';
                        sizeError.style.borderRadius = '10px';
                        sizeError.style.marginBottom = '20px';
                        sizeError.style.textAlign = 'center';
                        sizeError.style.fontWeight = '600';
                        sizeError.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> <strong>Upload Limit Exceeded:</strong> Total file size is ' + (totalSize / (1024 * 1024)).toFixed(2) + 'MB. Vercel limits submissions to 4.0MB. Please compress your files and try again.';
                        
                        submitBtn.parentNode.insertBefore(sizeError, submitBtn);
                        sizeError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }

                    const requiredFiles = this.querySelectorAll('input.file-input-hidden[data-required="true"]');
                    
                    requiredFiles.forEach(input => {
                        if (input.files.length === 0) {
                            isValid = false;
                            const container = input.closest('.stylish-upload-container');
                            
                            container.style.borderColor = 'var(--accent-orange)';
                            container.querySelector('.upload-text-main').style.color = 'var(--accent-orange)';
                            
                            if (!container.querySelector('.validation-error-msg')) {
                                const errorText = document.createElement('div');
                                errorText.className = 'validation-error-msg';
                                errorText.style.color = 'var(--accent-orange)';
                                errorText.style.fontSize = '0.85rem';
                                errorText.style.marginTop = '10px';
                                errorText.style.fontWeight = '600';
                                errorText.innerHTML = '<i class="fa-solid fa-circle-exclamation"></i> Please upload this document';
                                container.appendChild(errorText);
                            }
                        }
                    });

                    if (!isValid) {
                        e.preventDefault(); // Stop submission
                        
                        // Scroll to first error
                        const firstError = document.querySelector('.stylish-upload-container[style*="border-color: var(--accent-orange)"]');
                        if (firstError) {
                            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                });
                </script>

                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px; font-size: 1.1rem; padding: 18px;">
                    <i class="fa-solid fa-paper-plane" style="margin-right: 10px;"></i> Submit Secure Application
                </button>
            </form>
            
        </div>
    </div>
</div>
{% endblock %}
